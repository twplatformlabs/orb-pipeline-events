# src/commands/gh-buildx-image-release-notes.yml
# yamllint disable rule:line-length
---
description: |
  Use Github CLI to create or update github release notes for docker images based on a bake file.
  Pass a 'title' to reference the semantic tag of the release. Will append optional details to the notes-from-file.

  - Use notes-from-file to specify filepath for note contents
  - (Optional) Use include-commit-msg to append all commit messages since last tag
  - (Optional) Use include-sbom-guidance to automate custom details to release notes
  - (Optional) Use mark-as-draft flag to set releases to Draft

parameters:

  title:
    description: Release title. Default is Tag.
    type: string
    default: "$CIRCLE_TAG"

  bake-file:
    description: Bake file defining images from which to pull sbom
    type: string
    default: "docker-bake.json"

  notes-from-file:
    description: Specify a file as the contents of the release note.
    type: string

  include-commit-msg:
    description: Include block with all commit messages since last tag
    type: boolean
    default: false

  include-sbom-guidance:
    description: Run local script to include custom details like installed version of specified packages in release notes
    type: boolean
    default: false

  entry-point:
    description: container entry point
    type: string
    default: /bin/bash

  guidance-path:
    description: Path to script that will generate custom details into release notes.
    type: string
    default: ""

  verify-tag:
    description: Verify version git tag
    type: boolean
    default: false

  mark-as-draft:
    description: |
      Mark release as a draft. Included to support later automated or manual
      processes for official releases.
    type: boolean
    default: false

steps:
  - when:
      name: append commit messages to release notes file
      condition: << parameters.include-commit-msg >>
      steps:
        - run:
            name: append commit messages to release notes file
            environment:
              OUTFILE: << parameters.notes-from-file >>
            command: <<include(scripts/append_commit_msg_to_notes.sh)>>
  - when:
      name: append specified package versions to release notes file
      condition: << parameters.include-sbom-guidance >>
      steps:
        - run:
            name: append sbom information from image manifest to release notes file
            environment:
              BAKEFILE: << parameters.bake-file >>
              TAG: << parameters.title >>
              OUTFILE: << parameters.notes-from-file >>
              ENTRY_POINT: << parameters.entry-point >>
              GUIDANCE_PATH: << parameters.guidance-path >>
            command: <<include(scripts/append_sbom_guidance_to_notes.sh)>>
  - run:
      name: Create release << parameters.title >>
      command: |
        gh release create --title << parameters.title >> \
                          <<#parameters.verify-tag>> --verify-tag <</parameters.verify-tag>> \
                          <<#parameters.mark-as-draft>> --draft <</parameters.mark-as-draft>> \
                          --notes-file <<parameters.notes-from-file>> \
                          << parameters.title >>
